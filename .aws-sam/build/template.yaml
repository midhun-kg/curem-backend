AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Curem Malaria Detection Backend
Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 10
    MemorySize: 128
    Architectures:
    - x86_64
    Layers:
    - Ref: UtilsLayer
    Environment:
      Variables:
        USERS_TABLE: curem-users
        JWT_SECRET: curem-signing-secret
Resources:
  UtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: utils-layer
      Description: Shared helpers like dbClient and response()
      ContentUri: UtilsLayer
      CompatibleRuntimes:
      - nodejs18.x
      - nodejs20.x
    Metadata:
      BuildMethod: nodejs20.x
      SamResourceId: UtilsLayer
  TablesResources:
    Type: AWS::Serverless::Application
    Properties:
      Location: TablesResources/template.yaml
    Metadata:
      SamResourceId: TablesResources
  SignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SignupFunction
      Handler: src/functions/auth/signup.handler
      Events:
        SignupAPI:
          Type: Api
          Properties:
            Path: /auth/signup
            Method: post
    Policies:
    - DynamoDBReadPolicy:
        TableName: curem-users
    Metadata:
      SamResourceId: SignupFunction
  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LoginFunction
      Handler: src/functions/auth/login.handler
      Events:
        LoginAPI:
          Type: Api
          Properties:
            Path: /auth/login
            Method: post
    Policies:
    - DynamoDBReadPolicy:
        TableName: curem-users
    Metadata:
      SamResourceId: LoginFunction
  LogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LogoutFunction
      Handler: src/functions/auth/logout.handler
      Events:
        LogoutAPI:
          Type: Api
          Properties:
            Path: /auth/logout
            Method: post
    Policies:
    - DynamoDBReadPolicy:
        TableName: curem-users
    Metadata:
      SamResourceId: LogoutFunction
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL for Prod stages
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.aclmazonaws.com/Prod
